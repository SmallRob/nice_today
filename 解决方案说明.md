# 前端502错误解决方案

## 问题分析

在生产环境中，前端访问出现502错误，但后端访问正常。经过分析，发现以下几个关键问题：

1. **环境变量拼写错误**：在 .env 文件中，`REACT_APP_API_DOMAIN` 被错误地拼写为 `REACT_APP_API_DOMAI`，导致前端无法正确获取 API 域名
2. **网络隔离问题**：外部 Nginx 和 Docker 容器在不同的网络中，无法通过容器名称相互访问
3. **IP地址硬编码**：Nginx 配置中使用了硬编码的 IP 地址，而不是容器名称
4. **前端 Nginx 配置错误**：前端容器的 Nginx 配置不正确，没有正确提供静态文件
5. **API路径处理复杂**：前端代码中有复杂的 API 路径处理逻辑，需要支持多种 API 路径

## 解决方案

### 1. 修复环境变量拼写错误

修复 .env 文件中的拼写错误，并设置正确的 API 域名：

```bash
# 前端服务配置
REACT_APP_BACKEND_PORT=5000
REACT_APP_API_DOMAIN=https://nice-mcp.leansoftx.com  # 修复拼写错误，并设置正确的域名
```

### 2. 修改外部 Nginx 配置

将外部 Nginx 配置中的 IP 地址引用改为容器名称引用，并添加对旧版 API 路径的支持：

```nginx
# 直接访问后端API服务，不经过前端容器
location /api/ {
    proxy_pass http://nice-today-api:5000/;
    # ...其他配置...
}

# 兼容旧版API路径
location /maya/ {
    proxy_pass http://nice-today-api:5000/maya/;
    # ...其他配置...
}

# 兼容旧版API路径
location /biorhythm/ {
    proxy_pass http://nice-today-api:5000/biorhythm/;
    # ...其他配置...
}

# 所有其他请求转发到前端服务
location / {
    proxy_pass http://nice-today-frontend:3000;
    # ...其他配置...
}
```

### 3. 修改 Docker 网络配置

将 Docker 网络设置为外部网络，确保外部 Nginx 可以访问：

```yaml
networks:
  default:
    name: tcd-front-nginx-network
    external: true
```

### 4. 创建增强的前端 Nginx 配置

创建一个增强的前端 Nginx 配置，支持静态文件和多种 API 路径：

```nginx
server {
    listen 80;
    
    # 根目录配置
    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
        try_files $uri $uri/ /index.html;
        
        # 添加CORS头部
        add_header 'Access-Control-Allow-Origin' '*' always;
    }

    # 代理API请求到后端服务
    location /api/ {
        proxy_pass http://nice-today-api:5000/;
        # ...其他配置...
    }
    
    # 兼容旧版API路径
    location /maya/ {
        proxy_pass http://nice-today-api:5000/maya/;
        # ...其他配置...
    }
    
    # 兼容旧版API路径
    location /biorhythm/ {
        proxy_pass http://nice-today-api:5000/biorhythm/;
        # ...其他配置...
    }
}
```

### 5. 创建自动化脚本

创建自动化脚本，简化部署和维护：

1. **create-docker-network.sh**：创建 Docker 网络
2. **connect-nginx-to-docker-network.sh**：将外部 Nginx 容器连接到 Docker 网络
3. **restart-services.sh**：自动修复环境变量并重启服务

### 6. 重启服务

使用 `restart-services.sh` 脚本重启所有服务：

```bash
./restart-services.sh
```

## 注意事项

1. 确保环境变量名称拼写正确，这是导致问题的主要原因
2. 确保 Docker 网络 `tcd-front-nginx-network` 已创建
3. 确保外部 Nginx 可以访问 Docker 网络
4. 前端应用的 API 请求逻辑比较复杂，需要支持多种 API 路径和前缀

## 验证方法

重启服务后，通过域名 `nice-mcp.leansoftx.com` 访问前端服务，应该能够正常访问，不再出现502错误。
