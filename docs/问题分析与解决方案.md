# 前端502错误问题分析与解决方案

## 问题分析

根据Nginx错误日志，我发现以下关键问题：

1. **连接被拒绝错误**：
   ```
   connect() failed (111: Connection refused) while connecting to upstream, client: 124.238.201.244, server: nice-mcp.leansoftx.com, request: "GET / HTTP/1.1", upstream: "http://172.18.0.4:3000/", host: "nice-mcp.leansoftx.com"
   ```
   外部Nginx无法连接到前端容器（172.18.0.4:3000）。

2. **错误日志路径问题**：
   ```
   testing "/etc/nginx/html" existence failed (2: No such file or directory) while logging request
   ```
   Nginx尝试访问不存在的目录来记录日志。

3. **端口映射不匹配**：
   在`docker-compose-prod.yml`中，前端容器映射到了`3880:3000`，但外部Nginx配置中直接访问的是`nice-today-frontend:3000`。

## 根本原因

1. **端口不匹配**：外部Nginx尝试访问前端容器的3000端口，但前端容器实际上在容器内部使用的是80端口（根据前端Nginx配置）。

2. **网络连接问题**：外部Nginx容器可能没有正确连接到Docker网络`tcd-front-nginx-network`。

3. **容器名称与配置不一致**：在`docker-compose-prod.yml`中，前端容器名称是`nice-today-frontend`，但在`connect-nginx-to-docker-network.sh`脚本中，假设外部Nginx容器名为`external-nginx`。

## 解决方案

### 1. 修改外部Nginx配置

修改`nginx/conf.d/nice-mcp.conf`文件，将前端服务的端口从3000改为80：

```nginx
# 所有其他请求转发到前端服务
location / {
    proxy_pass http://nice-today-frontend:80;  # 修改端口从3000到80
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # 添加以下配置以处理静态资源和WebSocket
    proxy_http_version 1.1;
    proxy_buffering off;
    proxy_cache off;
    proxy_redirect off;
    
    # 增加超时时间
    proxy_connect_timeout 60s;
    proxy_read_timeout 60s;
    proxy_send_timeout 60s;
    
    # 添加WebSocket支持
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
```

### 2. 修改Docker Compose配置

修改`docker-compose-prod.yml`文件，确保前端容器内部端口与外部Nginx配置一致：

```yaml
nice-today-frontend:
  image: leanisssharedacr.azurecr.io/mcp/nice_today-biorhythm-frontend:20250801
  container_name: nice-today-frontend
  ports:
    - "3880:80"  # 修改为80端口，与前端Nginx配置一致
  depends_on:
    - nice-today-api
  volumes:
    - ./nginx.conf:/etc/nginx/conf.d/default.conf
    - ./ssl:/etc/nginx/ssl:ro
  environment:
    - REACT_APP_BACKEND_PORT=5000
    - REACT_APP_API_DOMAIN=https://nice-mcp.leansoftx.com
    - NODE_ENV=production
    - WDS_SOCKET_PORT=0
  env_file:
    - .env
  restart: unless-stopped
```

### 3. 确保外部Nginx容器连接到Docker网络

修改`connect-nginx-to-docker-network.sh`脚本，使其能够正确识别外部Nginx容器：

```bash
#!/bin/bash

# 获取外部Nginx容器ID（通过更通用的方式）
NGINX_CONTAINER_ID=$(docker ps -qf "ancestor=nginx" | head -n 1)

if [ -z "$NGINX_CONTAINER_ID" ]; then
  echo "错误: 未找到外部Nginx容器"
  exit 1
fi

echo "找到外部Nginx容器: $NGINX_CONTAINER_ID"

# 将外部Nginx容器连接到tcd-front-nginx-network网络
if docker network inspect tcd-front-nginx-network | grep -q "$NGINX_CONTAINER_ID"; then
  echo "Nginx容器已连接到网络"
else
  echo "将Nginx容器连接到网络"
  docker network connect tcd-front-nginx-network $NGINX_CONTAINER_ID
fi

# 检查网络连接
docker network inspect tcd-front-nginx-network

echo "完成! 现在外部Nginx可以通过容器名称访问Docker网络中的服务"
```

### 4. 修改重启服务脚本

更新`restart-services.sh`脚本，确保在重启服务前连接外部Nginx到Docker网络：

```bash
#!/bin/bash

echo "===== 创建Docker网络 ====="
./create-docker-network.sh

echo "===== 连接外部Nginx到Docker网络 ====="
./connect-nginx-to-docker-network.sh

echo "===== 停止现有服务 ====="
docker-compose -f docker-compose-prod.yml down

echo "===== 复制最新的Nginx配置 ====="
cp nginx.conf ./frontend/nginx.conf

echo "===== 检查环境变量 ====="
if grep -q "REACT_APP_API_DOMAI=" .env; then
  echo "修复环境变量拼写错误..."
  sed -i 's/REACT_APP_API_DOMAI=/REACT_APP_API_DOMAIN=/g' .env
fi

echo "===== 设置API域名 ====="
if grep -q "REACT_APP_API_DOMAIN=" .env; then
  sed -i 's|REACT_APP_API_DOMAIN=.*|REACT_APP_API_DOMAIN=https://nice-mcp.leansoftx.com|g' .env
else
  echo "REACT_APP_API_DOMAIN=https://nice-mcp.leansoftx.com" >> .env
fi

echo "===== 启动服务 ====="
docker-compose -f docker-compose-prod.yml up -d

echo "===== 检查服务状态 ====="
docker-compose -f docker-compose-prod.yml ps

echo "===== 检查网络连接 ====="
docker network inspect tcd-front-nginx-network

echo "===== 服务已重启 ====="
echo "现在可以通过 nice-mcp.leansoftx.com 访问服务"
```

### 5. 添加错误日志目录

确保外部Nginx容器中存在`/etc/nginx/html`目录，用于存储错误日志：

```bash
# 在外部Nginx容器中创建错误日志目录
docker exec $(docker ps -qf "ancestor=nginx" | head -n 1) mkdir -p /etc/nginx/html
```

## 执行步骤

1. 修改`nginx/conf.d/nice-mcp.conf`文件，将前端服务的端口从3000改为80
2. 修改`docker-compose-prod.yml`文件，将前端容器端口映射从`3880:3000`改为`3880:80`
3. 更新`connect-nginx-to-docker-network.sh`脚本，使其能够正确识别外部Nginx容器
4. 更新`restart-services.sh`脚本，确保在重启服务前连接外部Nginx到Docker网络
5. 在外部Nginx容器中创建错误日志目录
6. 执行`./restart-services.sh`脚本重启所有服务

## 验证方法

重启服务后，通过域名`nice-mcp.leansoftx.com`访问前端服务，应该能够正常访问，不再出现502错误。